# Vehicular Network Simulation System Based on Veins - Backend

This repository contains the backend service for a web-based Vehicular Network Simulation System, developed as a bachelor's thesis project. This `README.md` focuses exclusively on the backend service.

The project aims to address the inherent complexities of the Veins simulation platform, such as its complex operational requirements, strong environmental dependencies, and steep learning curve. By providing a modern web interface (frontend built with NiceGUI, **not included in this repository**), the backend system encapsulates the entire simulation workflow into simple, intuitive API calls, handling user management, project configuration, task scheduling, and results storage.

## System Architecture

The backend employs a modern, decoupled architecture that deeply integrates asynchronous task processing and containerization to achieve an efficient, isolated, and scalable simulation environment.

1.  **API Service (FastAPI)**: A high-performance API service built with Python's FastAPI framework. It provides RESTful endpoints to handle all business logic, including user authentication (JWT), project management, and the creation of simulation tasks.
2.  **Database (SQLite)**: A lightweight SQLite database is used for data persistence, managed via SQLModel for data modeling and interaction. It stores metadata for users, projects, and simulation tasks.
3.  **Asynchronous Task Queue (Celery & Redis)**: Time-consuming Veins simulation tasks are dispatched by the API service to a Redis message broker. A dedicated pool of Celery workers consumes these tasks asynchronously.
4.  **Containerized Simulation Environment (Docker)**: For each simulation task, a Celery worker dynamically launches a pre-built Docker container via the Docker SDK. This container encapsulates a complete, standardized Veins, OMNeT++, and SUMO environment, ensuring simulation consistency and isolation. It also integrates the noVNC stack to enable remote, web-based visualization of the simulation process.

## Key Features

- **Unified User Authentication**: Secure user registration, login, and permission management based on JWT.
- **Project Management**: Allows users to create simulation projects, and upload and manage associated configuration files (e.g., `.ini`, `.net.xml`, `.rou.xml`).
- **Asynchronous Simulation Tasks**: Utilizes Celery to execute simulations asynchronously, ensuring the web API remains responsive and is not blocked by long-running tasks.
- **Containerized Execution**: Each simulation task runs in a clean, isolated Docker container, completely resolving environment dependency and conflict issues.
- **Remote Process Visualization**: Supports running simulations in GUI mode with real-time viewing and interaction via noVNC directly in a web browser.
- **Comprehensive Admin Panel**: Administrators have full oversight and management capabilities for all users, projects, and simulation tasks in the system.
- **Auto-generated API Documentation**: Interactive OpenAPI (Swagger) documentation is automatically generated by FastAPI.

## Technology Stack

| Category | Technology |
| :--- | :--- |
| **Backend Framework** | FastAPI, Uvicorn |
| **Data Modeling** | SQLModel |
| **Database** | SQLite |
| **Async Tasks** | Celery |
| **Message Broker / Result Backend** | Redis |
| **Containerization** | Docker, Docker SDK for Python |
| **Authentication** | JWT (pyjwt), Passlib, Bcrypt |
| **Testing** | Pytest |

## Setup and Installation

The backend consists of three core components that require separate setup and execution:
1.  **The FastAPI Main Application**
2.  **The Celery Asynchronous Task Worker**
3.  **The Veins Simulation Environment Docker Image**

**Prerequisites**:
- Git
- Python 3.12+
- Docker
- Redis (running, can be installed via Docker)

### 1. Clone the Project

```bash
git clone https://github.com/Foxerine/vein-based-iov-simulator.git
cd vein-based-iov-simulator
```

### 2. Create the Configuration File

In the project's root directory, create a file named `config.cfg` and populate it according to your environment.

**`config.cfg` Example**:
```toml
# Default administrator account
admin_email = "admin@example.com"
admin_password = "a_very_strong_password"

# IMPORTANT: Change this to a 256-bit random string
jwt_secret = "YOUR_SUPER_SECRET_RANDOM_STRING_HERE"
jwt_algorithm = "HS256"
jwt_access_token_expire_minutes = 20160 # 14 days

# Storage paths for database, projects, and results
database_url = "sqlite+aiosqlite:///./data.db"
user_projects_base_dir = "user_projects"
runs_base_dir_name_in_project = "runs"

# Debug and testing flags
debug = false
testing = false

# Celery Configuration
celery_broker_url = "redis://localhost:6379/0"
celery_result_backend = "redis://localhost:6379/1"

# Simulation-related settings
simulation_max_timeout = 14400  # Max simulation duration in seconds (default: 4 hours)
max_concurrent_simulations = 4  # Number of concurrent Celery workers, recommend less than CPU cores
```

### 3. Set Up FastAPI Main Application Environment

```bash
# Create and activate a Python virtual environment
python -m venv venv_main
source venv_main/bin/activate  # On Windows: venv_main\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

### 4. Set Up Celery Worker Environment

The worker has slightly different dependencies. It is recommended to create a separate environment for it.

```bash
# Create and activate the worker's virtual environment
python -m venv venv_worker
source venv_worker/bin/activate # On Windows: venv_worker\Scripts\activate

# Install worker dependencies
pip install -r requirements_worker.txt
```

### 5. Build the Veins Simulation Docker Image

This image contains the environment where simulations will actually be executed.

```bash
# Navigate to the worker directory
cd worker

# Build the Docker image
# NOTE: This process downloads and compiles numerous components and may take a significant amount of time.
docker build -t veins-simulation-worker:latest .

# Return to the project root
cd ..
```

## Running the Project

Ensure that your **Docker** and **Redis** services are running.

### 1. Start the FastAPI Backend Service

In your **first** terminal window, activate the main application's virtual environment and start the service.

```bash
# Activate the main app's virtual environment
source venv_main/bin/activate

# Start FastAPI
uvicorn main:app --reload
```
Once the service starts, the `data.db` database file will be created automatically, and the administrator account specified in `config.cfg` will be initialized.

### 2. Start the Celery Worker

In a **second** terminal window, activate the worker's virtual environment and start it.

```bash
# Activate the worker's virtual environment
source venv_worker/bin/activate

# Start the Celery worker
celery -A worker.worker.celery_app worker --loglevel=info
```

The entire backend system is now ready and can accept requests from a frontend or an API client.

## API Documentation

Once the project is running, FastAPI automatically generates interactive API documentation.

- **Swagger UI**: [http://localhost:8000/docs](http://localhost:8000/docs)
- **ReDoc**: [http://localhost:8000/redoc](http://localhost:8000/redoc)

### API Endpoints Overview

| Tag | Method | Path | Description |
| :--- | :--- | :--- | :--- |
| **Authentication** | `POST` | `/api/auth/register` | Register a new user. |
| | `POST` | `/api/auth/login` | Log in to get an access token. |
| **User** | `GET` | `/api/user` | Get current user's information. |
| | `PATCH` | `/api/user` | Update current user's information. |
| | `DELETE`| `/api/user` | Delete the current user. |
| **Project** | `POST` | `/api/project` | Create a new project and upload files. |
| | `GET` | `/api/project` | List projects for the current user. |
| | `GET` | `/api/project/{id}` | Get project details. |
| | `PATCH` | `/api/project/{id}` | Update project info or files. |
| | `DELETE`| `/api/project/{id}` | Delete a project. |
| | `GET` | `/api/project/{id}/files`| Download project files as a ZIP archive. |
| **Simulation Run**| `POST` | `/api/run` | Create a simulation task from a project. |
| | `POST` | `/api/run/{id}/execute` | Execute a pending simulation task. |
| | `GET` | `/api/run/{id}` | Get simulation task details and status. |
| | `POST` | `/api/run/{id}/cancel` | Cancel a running simulation task. |
| | `GET` | `/api/run/{id}/files`| Download simulation results as a ZIP archive. |
| **Admin** | *...* | `/api/admin/...` | Provides CRUD operations for all users, projects, and runs. |

## Project Structure

```
.
├── api/                # FastAPI Router Modules
│   ├── admin.py        # Admin-related APIs
│   ├── auth.py         # Authentication APIs
│   ├── project.py      # Project Management APIs
│   ├── run.py          # Simulation Run Management APIs
│   └── user.py         # Regular User APIs
├── models/             # SQLModel Data Models
│   ├── database_connection.py # DB connection and initialization
│   ├── project.py      # Project model
│   ├── run.py          # Simulation Run model
│   └── user.py         # User model
├── tests/              # Pytest unit and integration tests
├── utils/              # Utility Modules
│   ├── auth.py         # Password hashing, JWT token handling
│   ├── depends.py      # FastAPI dependency injections
│   └── files.py        # File handling utilities
├── worker/             # Celery Worker & Simulation Environment
│   ├── dockerfile      # Dockerfile for the Veins simulation environment
│   ├── entrypoint.sh   # Entrypoint script for the Docker container
│   └── worker.py       # Celery task definitions
├── user_projects/      # Stores user-uploaded project files and results (generated at runtime)
├── config.cfg          # Project configuration file (must be created manually)
├── main.py             # FastAPI application entrypoint
├── requirements.txt    # Dependencies for the main FastAPI app
└── requirements_worker.txt # Dependencies for the Celery worker
```

## Acknowledgements

I would like to express my sincere gratitude to my advisor, **Bo Li**, from Hunan Agricultural University, for his invaluable guidance and support throughout the design and development of this project. His expertise and insightful advice were crucial to the successful completion of this work.

## License

This project is licensed under the [MIT License](LICENSE).
